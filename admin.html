<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>üì¨ –ê–¥–º–∏–Ω: –°–æ–æ–±—â–µ–Ω–∏—è</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 30px; 
            background: #f1f3f5; 
            margin: 0; 
        }
        h1 { 
            color: #1a73e8; 
        }
        .msg {
            background: white;
            border: 1px solid #ddd;
            margin: 15px 0;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        textarea {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 16px;
        }
        button {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 3px;
            font-size: 14px;
        }
        button:hover {
            background: #1557a7;
        }
        .delete-btn {
            background: #ea4335;
        }
        .delete-btn:hover {
            background: #d3302f;
        }
        .reply {
            margin-left: 20px;
            padding: 10px;
            background: #e8f5e8;
            border-left: 4px solid #34a853;
            font-size: 16px;
        }
        .time {
            font-size: 0.9em;
            color: #666;
        }
        .controls {
            margin-top: 10px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <h1>üì¨ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
    <p><strong>–°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</strong></p>
    <div id="list"></div>

    <script>
        // –î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞, –ø–æ–∫–∞ –ø–µ—á–∞—Ç–∞–µ—à—å
        const typedReplies = {};

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        function loadMessages() {
            const container = document.getElementById("list");
            container.innerHTML = ""; // –û—á–∏—â–∞–µ–º

            let messages = [];
            try {
                const data = localStorage.getItem("messages");
                if (data) {
                    messages = JSON.parse(data);
                }
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è messages:", e);
                messages = [];
            }

            messages.forEach(msg => {
                if (!msg.id || !msg.text) return;

                const msgId = parseInt(msg.id);
                const div = document.createElement("div");
                div.className = "msg";
                div.id = `msg-${msgId}`;

                let replySection = '';

                // –ï—Å–ª–∏ –µ—â—ë –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª
                if (!msg.replied) {
                    const savedText = typedReplies[msgId] || '';
                    replySection = `
                        <div class="reply-box">
                            <textarea 
                                id="reply_input_${msgId}" 
                                placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –æ—Ç–≤–µ—Ç..."
                            >${savedText}</textarea><br>
                            <div class="controls">
                                <button onclick="sendReply(${msgId})">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
                                <button class="delete-btn" onclick="deleteMessage(${msgId})">–£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        </div>
                    `;
                } else {
                    // –£–∂–µ –æ—Ç–≤–µ—Ç–∏–ª
                    replySection = `
                        <div class="reply" id="reply-${msgId}">
                            <strong>üìå –í—ã:</strong> ${msg.reply || ''}
                        </div>
                        <div class="controls">
                            <button class="delete-btn" onclick="deleteMessage(${msgId})">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    `;
                }

                div.innerHTML = `
                    <div><strong>üí¨</strong> ${msg.text}</div>
                    <div class="time">üïí ${msg.time || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</div>
                    ${replySection}
                `;

                container.appendChild(div);
            });

            if (messages.length === 0) {
                container.innerHTML = "<p>–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π...</p>";
            }
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—Å—Ç, –ø–æ–∫–∞ –ø–µ—á–∞—Ç–∞–µ–º
        function saveTyping(id) {
            const input = document.getElementById(`reply_input_${id}`);
            if (input) {
                typedReplies[id] = input.value;
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞
        function sendReply(id) {
            const input = document.getElementById(`reply_input_${id}`);
            if (!input) return;

            const text = input.value.trim();
            if (!text) {
                alert("–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç");
                return;
            }

            let messages = [];
            try {
                const data = localStorage.getItem("messages");
                messages = data ? JSON.parse(data) : [];
            } catch (e) {
                messages = [];
            }

            const msg = messages.find(m => m.id == id);  // == —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–æ —Å string/number
            if (msg) {
                msg.replied = true;
                msg.reply = text;

                try {
                    localStorage.setItem("messages", JSON.stringify(messages));
                    alert("–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
                    delete typedReplies[id];
                } catch (e) {
                    alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç");
                    console.error(e);
                }
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            const replyBox = document.querySelector(`#msg-${id} .reply-box`);
            if (replyBox) {
                replyBox.outerHTML = `
                    <div class="reply" id="reply-${id}">
                        <strong>üìå –í—ã:</strong> ${text}
                    </div>
                    <div class="controls">
                        <button class="delete-btn" onclick="deleteMessage(${id})">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                `;
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        function deleteMessage(id) {
            if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?")) {
                return;
            }

            let messages = [];
            try {
                const data = localStorage.getItem("messages");
                messages = data ? JSON.parse(data) : [];
            } catch (e) {
                messages = [];
            }

            const msgId = parseInt(id);

            // –§–∏–ª—å—Ç—Ä—É–µ–º ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ, —É –∫–æ–≥–æ id –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç
            const filtered = messages.filter(m => {
                return parseInt(m.id) !== msgId;
            });

            try {
                localStorage.setItem("messages", JSON.stringify(filtered));
                console.log("–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ:", msgId);
            } catch (e) {
                alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è");
                console.error(e);
                return;
            }

            // –£–¥–∞–ª—è–µ–º –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            const element = document.getElementById(`msg-${msgId}`);
            if (element) {
                element.remove();
            }

            alert("–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ");
        }

        // –°–ª—É—à–∞–µ–º –≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞
        window.addEventListener('input', (e) => {
            const match = e.target.id?.match(/reply_input_(\d+)/);
            if (match) {
                saveTyping(parseInt(match[1]));
            }
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
        setInterval(loadMessages, 10000);
        loadMessages(); // –ü–µ—Ä–≤—ã–π —Ä–∞–∑ —Å—Ä–∞–∑—É
    </script>
</body>
</html>
