<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ê–¥–º–∏–Ω: –°–æ–æ–±—â–µ–Ω–∏—è</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 30px;
            background: #f8f9fa;
            margin: 0;
        }
        #login {
            text-align: center;
            padding: 50px;
            font-size: 18px;
        }
        #login input {
            padding: 10px;
            font-size: 16px;
            margin: 10px;
            width: 200px;
        }
        button {
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
        }
        .msg {
            background: white;
            border: 1px solid #ddd;
            margin: 15px 0;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        textarea {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .reply {
            margin-left: 20px;
            padding: 10px;
            background: #e8f5e8;
            border-left: 4px solid #28a745;
        }
        .time {
            font-size: 0.9em;
            color: #6c757d;
        }
        #messages-container {
            display: none;
        }
    </style>
</head>
<body>
    <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
    <div id="login">
        <h2>üîê –í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω–∫—É</h2>
        <p>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</p>
        <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å"><br>
        <button onclick="checkPassword()">–í–æ–π—Ç–∏</button>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div id="messages-container" style="display:none;">
        <h1>üì¨ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
        <p><strong>–°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</strong></p>
        <div id="list"></div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
        import { getDatabase, ref, onValue, update } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js';

        // –¢–≤–æ–π –∫–æ–Ω—Ñ–∏–≥
        const firebaseConfig = {
            apiKey: "AIzaSyAC1f-AEPI7_EPPZoPo212qezJp_72QqQM",
            authDomain: "chat-enternet.firebaseapp.com",
            databaseURL: "https://chat-enternet-default-rtdb.firebaseio.com",
            projectId: "chat-enternet",
            storageBucket: "chat-enternet.firebasestorage.app",
            messagingSenderId: "838607253492",
            appId: "1:838607253492:web:3ad13610daab65251193a1"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        const app = initializeApp(firebaseConfig);
        const db = getDatabase();

        // üîê –ü–∞—Ä–æ–ª—å –Ω–∞ –∞–¥–º–∏–Ω–∫—É
        const ADMIN_PASSWORD = "trofim123";  // ‚Üê –ò–∑–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π

        function checkPassword() {
            const input = document.getElementById("password").value;
            if (input === ADMIN_PASSWORD) {
                document.getElementById("login").style.display = "none";
                document.getElementById("messages-container").style.display = "block";
                loadMessages();
            } else {
                alert("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!");
            }
        }

        document.getElementById("password").addEventListener("keydown", (e) => {
            if (e.key === "Enter") checkPassword();
        });

        const typedReplies = {};

        function loadMessages() {
            const messagesRef = ref(db, 'messages');
            onValue(messagesRef, (snapshot) => {
                const container = document.getElementById("list");
                container.innerHTML = "";

                const messages = snapshot.val();
                if (!messages) {
                    container.innerHTML = "<p>–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π...</p>";
                    return;
                }

                Object.values(messages).forEach(msg => {
                    if (!msg.id) return;

                    const div = document.createElement("div");
                    div.className = "msg";
                    div.id = `msg-${msg.id}`;

                    let replySection = '';
                    if (!msg.replied) {
                        const savedText = typedReplies[msg.id] || '';
                        replySection = `
                            <div class="reply-box">
                                <textarea id="reply_input_${msg.id}" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –æ—Ç–≤–µ—Ç...">${savedText}</textarea><br>
                                <button onclick="sendReply('${msg.id}')">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
                            </div>
                        `;
                    } else {
                        replySection = `
                            <div class="reply">
                                <strong>üìå –í—ã:</strong> ${msg.reply}
                            </div>
                        `;
                    }

                    div.innerHTML = `
                        <div><strong>üí¨</strong> ${msg.text}</div>
                        <div class="time">üïí ${msg.time}</div>
                        ${replySection}
                    `;

                    container.appendChild(div);
                });
            });
        }

        window.saveTyping = function(id) {
            const input = document.getElementById(`reply_input_${id}`);
            if (input) typedReplies[id] = input.value;
        };

        window.sendReply = function(id) {
            const input = document.getElementById(`reply_input_${id}`);
            const text = input.value.trim();
            if (!text) {
                alert("–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç");
                return;
            }

            const messageRef = ref(db, 'messages/' + id);
            update(messageRef, {
                replied: true,
                reply: text,
                reply_time: new Date().toLocaleString()
            }).then(() => {
                alert("–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
                delete typedReplies[id];
            });
        };

        // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
        document.addEventListener('input', (e) => {
            const match = e.target.id?.match(/reply_input_(.+)/);
            if (match) window.saveTyping(match[1]);
        });
    </script>
</body>
</html>
