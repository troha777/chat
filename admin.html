<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>üì¨ –ê–¥–º–∏–Ω: –°–æ–æ–±—â–µ–Ω–∏—è</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 30px; 
            background: #f1f3f5; 
            margin: 0; 
        }
        h1 { 
            color: #1a73e8; 
        }
        .msg {
            background: white;
            border: 1px solid #ddd;
            margin: 15px 0;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        textarea {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 16px;
        }
        button {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 3px;
            font-size: 14px;
        }
        button:hover {
            background: #1557a7;
        }
        .delete-btn {
            background: #ea4335;
        }
        .delete-btn:hover {
            background: #d3302f;
        }
        .reply {
            margin-left: 20px;
            padding: 10px;
            background: #e8f5e8;
            border-left: 4px solid #34a853;
        }
        .time {
            font-size: 0.9em;
            color: #666;
        }
        .controls {
            margin-top: 10px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .empty {
            color: #888;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>üì¨ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
    <p><strong>–°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</strong></p>
    <div id="list"></div>

    <script>
        const typedReplies = {};

        function loadMessages() {
            const container = document.getElementById("list");
            container.innerHTML = "";

            let messages = [];
            try {
                const data = localStorage.getItem("messages");
                messages = data ? JSON.parse(data) : [];
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ messages:", e);
                messages = [];
            }

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –Ω–æ–≤—ã–µ ‚Äî —Å–≤–µ—Ä—Ö—É
            messages.sort((a, b) => b.id - a.id);

            if (messages.length === 0) {
                container.innerHTML = '<p class="empty">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π...</p>';
                return;
            }

            messages.forEach(msg => {
                if (!msg.id || !msg.text) return;

                const msgId = msg.id;
                const div = document.createElement("div");
                div.className = "msg";
                div.id = `msg-${msgId}`;

                let replySection = '';

                if (!msg.replied) {
                    const savedText = typedReplies[msgId] || '';
                    replySection = `
                        <div class="reply-box">
                            <textarea 
                                id="reply_input_${msgId}" 
                                placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –æ—Ç–≤–µ—Ç..."
                            >${savedText}</textarea><br>
                            <div class="controls">
                                <button onclick="sendReply(${msgId})">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
                                <button class="delete-btn" onclick="deleteMessage(${msgId})">–£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        </div>
                    `;
                } else {
                    replySection = `
                        <div class="reply" id="reply-${msgId}">
                            <strong>üìå –í—ã:</strong> ${msg.reply || '[–ø—É—Å—Ç–æ]'}
                        </div>
                        <div class="controls">
                            <button class="delete-btn" onclick="deleteMessage(${msgId})">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    `;
                }

                div.innerHTML = `
                    <div><strong>üí¨</strong> ${msg.text}</div>
                    <div class="time">üïí ${msg.time || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</div>
                    ${replySection}
                `;

                container.appendChild(div);
            });
        }

        function saveTyping(id) {
            const input = document.getElementById(`reply_input_${id}`);
            if (input) typedReplies[id] = input.value;
        }

        function sendReply(id) {
            const input = document.getElementById(`reply_input_${id}`);
            if (!input) return;

            const text = input.value.trim();
            if (!text) {
                alert("–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç");
                return;
            }

            let messages = [];
            try {
                const data = localStorage.getItem("messages");
                messages = data ? JSON.parse(data) : [];
            } catch (e) {
                messages = [];
            }

            const msg = messages.find(m => m.id == id);
            if (msg) {
                msg.replied = true;
                msg.reply = text;

                try {
                    localStorage.setItem("messages", JSON.stringify(messages));
                    alert("–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
                    delete typedReplies[id];
                } catch (e) {
                    alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
                    console.error(e);
                    return;
                }
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            const replyBox = document.querySelector(`#msg-${id} .reply-box`);
            if (replyBox) {
                replyBox.outerHTML = `
                    <div class="reply" id="reply-${id}">
                        <strong>üìå –í—ã:</strong> ${text}
                    </div>
                    <div class="controls">
                        <button class="delete-btn" onclick="deleteMessage(${id})">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                `;
            }
        }

        function deleteMessage(id) {
            if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?")) {
                return;
            }

            let messages = [];
            try {
                const data = localStorage.getItem("messages");
                messages = data ? JSON.parse(data) : [];
            } catch (e) {
                messages = [];
            }

            const filtered = messages.filter(m => m.id != id);

            try {
                localStorage.setItem("messages", JSON.stringify(filtered));
            } catch (e) {
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏");
                console.error(e);
                return;
            }

            const element = document.getElementById(`msg-${id}`);
            if (element) element.remove();

            if (filtered.length === 0) {
                document.getElementById("list").innerHTML = '<p class="empty">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π...</p>';
            }

            alert("–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ");
        }

        // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
        window.addEventListener('input', (e) => {
            const match = e.target.id?.match(/reply_input_(\d+)/);
            if (match) saveTyping(parseInt(match[1]));
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
        setInterval(loadMessages, 10000);
        loadMessages(); // —Å—Ä–∞–∑—É
    </script>
</body>
</html>
